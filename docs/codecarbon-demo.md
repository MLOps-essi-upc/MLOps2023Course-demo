# CodeCarbon demo for the MLOps 2023-24 course <!-- omit in toc -->
In this demo we will see the main features of [CodeCarbon](https://mlco2.github.io/codecarbon/index.html), a Python
package to track the carbon emissions of machine learning projects.

## Contents <!-- omit in toc -->
- [Install CodeCarbon](#install-codecarbon)
  - [Using poetry](#using-poetry)
  - [Using pdm](#using-pdm)
  - [Using pipenv](#using-pipenv)
  - [Using pip](#using-pip)
- [Tracking emissions](#tracking-emissions)
  - [Using the `EmissionsTracker` class](#using-the-emissionstracker-class)
  - [Using the `EmissionsTracker` context manager](#using-the-emissionstracker-context-manager)
  - [Using the `track_emissions` decorator](#using-the-track_emissions-decorator)


## Install CodeCarbon
First, we need to install CodeCarbon. We can do this by running the following command:

### Using poetry
```bash
poetry add codecarbon
```

### Using pdm
```bash
pdm add codecarbon
```

### Using pipenv
```bash
pipenv install codecarbon
```

### Using pip
```bash
pip install codecarbon
```

## Tracking emissions
There are three ways to track the emissions of a machine learning project with CodeCarbon:

### Using the `EmissionsTracker` class
```python
from codecarbon import EmissionsTracker

tracker = EmissionsTracker()
tracker.start()
# Your training code here
tracker.stop()
```
> Note: The tracker.stop() returns the total emissions in CO2e (kg) as a float.

### Using the `EmissionsTracker` context manager
```python
from codecarbon import EmissionsTracker

with EmissionsTracker() as tracker:
    # Your training code here
```

### Using the `track_emissions` decorator
```python
from codecarbon import track_emissions

@track_emissions
def training_function():
    # Your training code here
```

For more information on each of these methods and their parameters, see the [CodeCarbon documentation](https://mlco2.github.io/codecarbon/parameters.html).

When you run your code with one of these methods, CodeCarbon will track the emissions of your machine learning project and save them in a CSV file. In addition, it will display some information in the terminal similar to the following:
```
[codecarbon INFO @ 13:27:25] [setup] RAM Tracking...
[codecarbon INFO @ 13:27:25] [setup] GPU Tracking...
[codecarbon INFO @ 13:27:25] Tracking Nvidia GPU via pynvml
[codecarbon INFO @ 13:27:25] [setup] CPU Tracking...
[codecarbon WARNING @ 13:27:25] No CPU tracking mode found. Falling back on CPU constant mode.
[codecarbon WARNING @ 13:27:27] We saw that you have a AMD Ryzen 5 5600H with Radeon Graphics but we don't know it. Please contact us.
[codecarbon INFO @ 13:27:27] CPU Model on constant consumption mode: AMD Ryzen 5 5600H with Radeon Graphics
[codecarbon INFO @ 13:27:27] >>> Tracker's metadata:
[codecarbon INFO @ 13:27:27]   Platform system: Windows-10-10.0.22621-SP0
[codecarbon INFO @ 13:27:27]   Python version: 3.10.6
[codecarbon INFO @ 13:27:27]   CodeCarbon version: 2.2.7
[codecarbon INFO @ 13:27:27]   Available RAM : 15.345 GB
[codecarbon INFO @ 13:27:27]   CPU count: 12
[codecarbon INFO @ 13:27:27]   CPU model: AMD Ryzen 5 5600H with Radeon Graphics
[codecarbon INFO @ 13:27:27]   GPU count: 1
[codecarbon INFO @ 13:27:27]   GPU model: 1 x NVIDIA GeForce RTX 3050 Laptop GPU
[codecarbon INFO @ 13:27:33] Energy consumed for RAM : 0.000009 kWh. RAM Power : 5.754538536071777 W
[codecarbon INFO @ 13:27:33] Energy consumed for all GPUs : 0.000010 kWh. Total GPU Power : 6.392 W
[codecarbon INFO @ 13:27:33] Energy consumed for all CPUs : 0.000066 kWh. Total CPU Power : 42.5 W
[codecarbon INFO @ 13:27:33] 0.000085 kWh of electricity used since the beginning.
```

For an example of how to use CodeCarbon and log the emissions to MLflow, see the [`train.py`](../src/models/train.py) [`api.py`](../src/app/api.py) files. For
an example of an emissions metrics generated by CodeCarbon, see the [`emissions.csv`](../metrics/emissions.csv) file.
